deploy:
  needs: build-and-push
  runs-on: ubuntu-latest
  steps:
    - name: Install SSH key
      run: |
        mkdir -p ~/.ssh
        # Сохраняем ключ с правильными переносами строк
        echo "${{ secrets.SSH_PRIVATE_KEY }}" | sed 's/\r$//' > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        # Добавляем хост в known_hosts
        ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
    
    - name: Test SSH connection
      run: |
        ssh -i ~/.ssh/id_rsa \
          -p ${{ secrets.SSH_PORT || '22' }} \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "echo 'SSH connection successful'"
    
    - name: Deploy to server
      run: |
        ssh -i ~/.ssh/id_rsa \
          -p ${{ secrets.SSH_PORT || '22' }} \
          -o StrictHostKeyChecking=no \
          ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
          "
          echo '${{ secrets.GHCR_TOKEN || secrets.GITHUB_TOKEN }}' | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          docker pull ghcr.io/${{ github.repository }}:latest
          docker stop fastapi-time 2>/dev/null || true
          docker rm fastapi-time 2>/dev/null || true
          docker run -d \
            --name fastapi-time \
            -p 8000:8000 \
            --restart unless-stopped \
            ghcr.io/${{ github.repository }}:latest
          "